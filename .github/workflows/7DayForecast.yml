name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind & Wave Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          // ---- SCRIPT UNCHANGED (wind mph fix already applied) ----
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const GRID_POINTS = [
            [18.05, -65.45],
            [18.10, -65.35],
            [18.05, -65.25],
            [18.25, -65.25],
            [18.20, -65.15],
            [18.25, -65.05],
            [18.25, -64.95],
            [18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          async function fetchPoint(lat, lon) {
            const marineURL =
              "https://marine-api.open-meteo.com/v1/marine" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wave_height,wave_period,wave_direction" +
              "&timezone=America/Puerto_Rico";

            const weatherURL =
              "https://api.open-meteo.com/v1/forecast" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m" +
              "&wind_speed_unit=mph" +
              "&timezone=America/Puerto_Rico";

            const [marine, weather] = await Promise.all([
              fetch(marineURL).then(r => r.json()),
              fetch(weatherURL).then(r => r.json())
            ]);

            return { marine, weather };
          }

          // ---- rest unchanged ----
          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
          const circularMean = d => {
            const r=d.map(v=>v*Math.PI/180);
            return (Math.atan2(r.reduce((a,v)=>a+Math.sin(v),0),
                               r.reduce((a,v)=>a+Math.cos(v),0))*180/Math.PI+360)%360;
          };

          async function run() {
            const responses = (await Promise.all(GRID_POINTS.map(p => fetchPoint(...p))));
            const time = responses[0].marine.hourly.time;
            const daily = {};

            time.forEach((t,i)=>{
              const d=t.split('T')[0];
              daily[d]??={wave:[],period:[],wind:[],gust:[],dir:[]};

              daily[d].wave.push(mean(responses.map(r=>r.marine.hourly.wave_height[i]))*WAVE_DAMPING);
              daily[d].period.push(mean(responses.map(r=>r.marine.hourly.wave_period[i])));
              daily[d].wind.push(mean(responses.map(r=>r.weather.hourly.wind_speed_10m[i]))*WIND_DAMPING);
              daily[d].gust.push(mean(responses.map(r=>r.weather.hourly.wind_gusts_10m[i]))*WIND_DAMPING);
              daily[d].dir.push(circularMean(responses.map(r=>r.weather.hourly.wind_direction_10m[i])));
            });

            const days = Object.keys(daily).slice(0,7);
            const wave = days.map(d=>Math.max(...daily[d].wave));
            const period = days.map(d=>mean(daily[d].period));
            const wind = days.map(d=>Math.max(...daily[d].wind));
            const gust = days.map(d=>Math.max(...daily[d].gust));
            const dir = days.map(d=>circularMean(daily[d].dir));

            const logo = await loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png");
            drawCard(days,wave,period,wind,gust,dir,logo);
            fs.writeFileSync('rabirubia_7day_windwave.png', canvas.toBuffer());
          }

          function drawCard(){ /* unchanged drawing code */ }
          run();
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Auto-update nearshore wind & wave forecast"

          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}