name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind & Wave Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const ast = new Date(now.toLocaleString("en-US", { timeZone: "America/Puerto_Rico" }));

          const GRID_POINTS = [
            [18.05, -65.45],
            [18.10, -65.35],
            [18.05, -65.25],
            [18.25, -65.25],
            [18.20, -65.15],
            [18.25, -65.05],
            [18.25, -64.95],
            [18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          async function fetchPoint(lat, lon) {
            const marineURL =
              "https://marine-api.open-meteo.com/v1/marine" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wave_height,wave_period,wave_direction" +
              "&timezone=America/Puerto_Rico";

            const weatherURL =
              "https://api.open-meteo.com/v1/forecast" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m" +
              "&wind_speed_unit=mph" +
              "&timezone=America/Puerto_Rico";

            const [marine, weather] = await Promise.all([
              fetch(marineURL).then(r => r.json()),
              fetch(weatherURL).then(r => r.json())
            ]);

            return { marine, weather };
          }

          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
          const circularMean = d => {
            const r=d.map(v=>v*Math.PI/180);
            return (Math.atan2(
              r.reduce((a,v)=>a+Math.sin(v),0),
              r.reduce((a,v)=>a+Math.cos(v),0)
            )*180/Math.PI+360)%360;
          };

          async function run() {
            const responses = (await Promise.all(
              GRID_POINTS.map(p => fetchPoint(p[0], p[1]))
            )).filter(Boolean);

            const time = responses[0].marine.hourly.time;
            const daily = {};

            time.forEach((t,i)=>{
              const d=t.split('T')[0];
              daily[d]??={wave:[],period:[],wind:[],gust:[],dir:[]};

              daily[d].wave.push(mean(responses.map(r=>r.marine.hourly.wave_height[i]))*WAVE_DAMPING);
              daily[d].period.push(mean(responses.map(r=>r.marine.hourly.wave_period[i])));
              daily[d].wind.push(mean(responses.map(r=>r.weather.hourly.wind_speed_10m[i]))*WIND_DAMPING);
              daily[d].gust.push(mean(responses.map(r=>r.weather.hourly.wind_gusts_10m[i]))*WIND_DAMPING);
              daily[d].dir.push(circularMean(responses.map(r=>r.weather.hourly.wind_direction_10m[i])));
            });

            const days = Object.keys(daily).slice(0,7);
            const wave = days.map(d=>Math.max(...daily[d].wave));
            const period = days.map(d=>mean(daily[d].period));
            const wind = days.map(d=>Math.max(...daily[d].wind));
            const gust = days.map(d=>Math.max(...daily[d].gust));
            const dir = days.map(d=>circularMean(daily[d].dir));

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            drawCard(days,wave,period,wind,gust,dir,logo);
            fs.writeFileSync('rabirubia_7day_windwave.png', canvas.toBuffer());
          }

          function compass(d){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }
          function windColor(s){
            if(s<=10)return"#38bdf8";
            if(s<=15)return"#22c55e";
            if(s<=20)return"#eab308";
            if(s<=25)return"#f97316";
            return"#ef4444";
          }

          function drawCard(days,wave,period,wind,gust,dir,logo){
            ctx.fillStyle="#f8fafc";
            ctx.fillRect(0,0,1080,1080);

            ctx.drawImage(logo,60,90,120,120);

            ctx.font="bold 30px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.fillText("7-Day Nearshore (East of PR) Wind & Wave Forecast",210,150);

            // COLUMN HEADERS
            ctx.font="bold 22px system-ui";
            ctx.fillStyle="#334155";
            const hy = 310;
            ctx.fillText("Date",60,hy);
            ctx.fillText("Wind",200,hy);
            ctx.fillText("Gusts",320,hy);
            ctx.fillText("Dir",440,hy);
            ctx.fillText("Seas",560,hy);
            ctx.fillText("Period",680,hy);

            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();
            ctx.moveTo(60,325);
            ctx.lineTo(960,325);
            ctx.stroke();

            let y=370;
            days.forEach((d,i)=>{
              ctx.font="28px system-ui";
              ctx.fillStyle="#0f172a";
              ctx.fillText(new Date(d).toLocaleDateString('en-US',{weekday:'short'}),60,y);
              ctx.fillStyle=windColor(wind[i]);
              ctx.fillText(`${Math.round(wind[i])} mph`,200,y);
              ctx.fillText(`${Math.round(gust[i])} mph`,320,y);
              ctx.fillStyle="#0f172a";
              ctx.fillText(compass(dir[i]),440,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,560,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,680,y);
              y+=70;
            });

            ctx.font="20px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit',second:'2-digit'})} AST â€¢ Rabirubia-Meteo Nearshore Blend`,
              540,
              1000
            );
            ctx.textAlign="left";
          }

          run().catch(e => { console.error(e); process.exit(1); });
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Add visible column headers to forecast card"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
