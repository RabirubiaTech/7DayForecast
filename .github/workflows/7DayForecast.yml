name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind & Wave Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4 * 60 * 60 * 1000);

          // -----------------------------
          // Nearshore micro-grid
          // -----------------------------
          const GRID_POINTS = [
            [18.05, -65.45],
            [18.10, -65.35],
            [18.05, -65.25],
            [18.25, -65.25],
            [18.20, -65.15],
            [18.25, -65.05],
            [18.25, -64.95],
            [18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          async function fetchPoint(lat, lon) {
            try {
              const marineURL =
                "https://marine-api.open-meteo.com/v1/marine" +
                `?latitude=${lat}&longitude=${lon}` +
                "&hourly=wave_height,wave_period,wave_direction" +
                "&timezone=America/Puerto_Rico";

              const weatherURL =
                "https://api.open-meteo.com/v1/forecast" +
                `?latitude=${lat}&longitude=${lon}` +
                "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m" +
                "&timezone=America/Puerto_Rico";

              const [marine, weather] = await Promise.all([
                fetch(marineURL).then(r => r.json()),
                fetch(weatherURL).then(r => r.json())
              ]);

              if (
                !marine?.hourly?.wave_height ||
                !weather?.hourly?.wind_speed_10m
              ) {
                console.warn(`Skipping invalid grid point ${lat}, ${lon}`);
                return null;
              }

              return { marine, weather };
            } catch {
              return null;
            }
          }

          const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

          const circularMean = degs => {
            const rad = degs.map(d => d * Math.PI / 180);
            const sin = rad.reduce((a, v) => a + Math.sin(v), 0);
            const cos = rad.reduce((a, v) => a + Math.cos(v), 0);
            return (Math.atan2(sin, cos) * 180 / Math.PI + 360) % 360;
          };

          async function run() {
            const responses = (await Promise.all(
              GRID_POINTS.map(p => fetchPoint(p[0], p[1]))
            )).filter(Boolean);

            if (responses.length < 2) {
              throw new Error("Insufficient valid nearshore data");
            }

            console.log(`Using ${responses.length}/${GRID_POINTS.length} grid points`);

            const time = responses[0].marine.hourly.time;
            const daily = {};

            time.forEach((t, i) => {
              const day = t.split('T')[0];
              daily[day] ??= { wave: [], period: [], wind: [], gust: [], dir: [] };

              const waves = responses.map(r => r.marine.hourly.wave_height[i]).filter(v => v != null);
              const periods = responses.map(r => r.marine.hourly.wave_period[i]).filter(v => v != null);
              const winds = responses.map(r => r.weather.hourly.wind_speed_10m[i]).filter(v => v != null);
              const gusts = responses.map(r => r.weather.hourly.wind_gusts_10m[i]).filter(v => v != null);
              const dirs = responses.map(r => r.weather.hourly.wind_direction_10m[i]).filter(v => v != null);

              if (!waves.length || !winds.length) return;

              daily[day].wave.push(mean(waves) * WAVE_DAMPING);
              daily[day].period.push(mean(periods));
              daily[day].wind.push(mean(winds) * WIND_DAMPING);
              daily[day].gust.push(mean(gusts) * WIND_DAMPING);
              daily[day].dir.push(circularMean(dirs));
            });

            const days = [];
            const wave = [];
            const period = [];
            const wind = [];
            const gust = [];
            const dir = [];

            Object.keys(daily).slice(0, 7).forEach(d => {
              days.push(d);
              wave.push(Math.max(...daily[d].wave));
              period.push(mean(daily[d].period));
              wind.push(Math.max(...daily[d].wind));
              gust.push(Math.max(...daily[d].gust));
              dir.push(circularMean(daily[d].dir));
            });

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            drawCard(days, wave, period, wind, gust, dir, logo);
            fs.writeFileSync('rabirubia_7day_windwave.png', canvas.toBuffer());
          }

          // -----------------------------
          // Drawing helpers (unchanged)
          // -----------------------------
          function compass(d){const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return dirs[Math.round(d/22.5)%16];}
          function arrowForDir(d){const deg=((d%360)+360)%360;if(deg>=337.5||deg<22.5)return"↑";if(deg<67.5)return"↗";if(deg<112.5)return"→";if(deg<157.5)return"↘";if(deg<202.5)return"↓";if(deg<247.5)return"↙";if(deg<292.5)return"←";return"↖";}
          function windColor(s){if(s<=10)return"#38bdf8";if(s<=15)return"#22c55e";if(s<=20)return"#eab308";if(s<=25)return"#f97316";return"#ef4444";}
          function dangerFlag(w,h){if(w>25||h>6)return{color:"#ef4444"};if(w>=15||h>=4)return{color:"#eab308"};return{color:"#22c55e"};}

          function drawCard(days, wave, period, wind, gust, dir, logo) {
            ctx.fillStyle="#f8fafc";ctx.fillRect(0,0,1080,1080);
            ctx.drawImage(logo,60,60,200,200);
            ctx.font="bold 42px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.fillText("7-Day Nearshore Wind & Wave Forecast",60,300);

            let y=360;
            days.forEach((d,i)=>{
              const flag=dangerFlag(wind[i],wave[i]);
              ctx.font="28px system-ui";
              ctx.fillStyle="#0f172a";
              ctx.fillText(new Date(d).toLocaleDateString('en-US',{weekday:'short'}),60,y);
              ctx.fillStyle=windColor(wind[i]);ctx.fillText(`${Math.round(wind[i])} mph`,200,y);
              ctx.fillText(`${Math.round(gust[i])} mph`,320,y);
              ctx.fillStyle="#0f172a";ctx.fillText(compass(dir[i]),440,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,560,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,680,y);
              ctx.fillStyle=flag.color;ctx.beginPath();ctx.arc(860,y-8,10,0,Math.PI*2);ctx.fill();
              y+=70;
            });
          }

          run().catch(e => { console.error(e); process.exit(1); });
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Nearshore-tuned PR/USVI marine forecast" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
