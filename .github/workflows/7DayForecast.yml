name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind, Wave & Buoy Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080,1080);
          const ctx = canvas.getContext('2d');

          const ast = new Date(new Date().toLocaleString("en-US",{timeZone:"America/Puerto_Rico"}));

          // ------------------ helpers ------------------
          const windColor = v => v<=10?"#38bdf8":v<=15?"#22c55e":v<=20?"#eab308":v<=25?"#f97316":"#ef4444";
          const hazardColor = (w,h)=> (w>=25||h>=6)?"#ef4444":(w>=15||h>=4)?"#eab308":"#22c55e";
          const cell = (x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};

          async function fetchBuoy(id){
            try{
              const t = await fetch(`https://www.ndbc.noaa.gov/data/realtime2/${id}.txt`).then(r=>r.text());
              const l=t.split('\n'); let h; const r=[];
              for(const ln of l){
                if(ln.startsWith("#YY"))h=ln.replace("#","").trim().split(/\s+/);
                else if(h&&!ln.startsWith("#")&&ln.trim())r.push(ln.trim().split(/\s+/));
              }
              const i=k=>h.indexOf(k);
              for(const p of r){
                if(p[i("WVHT")]!=="MM"&&p[i("WVHT")]!=="99.00"){
                  return{
                    id,
                    seas:(p[i("WVHT")]*3.28084).toFixed(1),
                    period:p[i("DPD")]!=="MM"?p[i("DPD")]:"N/A",
                    dir:p[i("MWD")]!=="999"?p[i("MWD")]:"N/A"
                  }
                }
              }
            }catch{}
            return{id,seas:"N/A",period:"N/A",dir:"N/A"}
          }

          async function run(){
            const days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
            const wind=[12,14,13,15,14,13,12];
            const gust=[17,18,17,19,18,17,16];
            const wave=[3.8,4.1,3.9,4.3,4.0,3.7,3.6];
            const period=[8.1,8.4,8.2,8.6,8.3,8.0,7.9];

            const b43=await fetchBuoy("41043");
            const b56=await fetchBuoy("41056");
            const logo=await loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png");

            draw(days,wind,gust,wave,period,b43,b56,logo);
            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          function draw(days,wind,gust,wave,period,b43,b56,logo){
            ctx.fillStyle="#f8fafc";ctx.fillRect(0,0,1080,1080);

            // LOGO
            ctx.drawImage(logo,60,40,100,100);

            // HEADER
            ctx.font="bold 28px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.textAlign="center";
            ctx.fillText("7-Day Nearshore (East of PR) Wind & Wave Forecast",540,95);

            // HEADERS
            ctx.font="bold 20px system-ui";
            ctx.fillStyle="#334155";
            const hy=170;
            ["ðŸ“… Date","ðŸŒ¬ Wind","ðŸ’¨ Gusts","ðŸ§­ Dir","ðŸŒŠ Seas","â± Period",""].forEach((t,i)=>{
              ctx.fillText(t,120+i*120,hy);
            });

            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(100,185);ctx.lineTo(980,185);ctx.stroke();

            // ROWS
            let y=225;
            ctx.font="20px system-ui";
            days.forEach((d,i)=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(d,120,y);

              cell(240,y-18,90,28,windColor(wind[i]));
              ctx.fillStyle="#0f172a";
              ctx.fillText(`${wind[i]} mph`,245,y);

              cell(360,y-18,90,28,windColor(gust[i]));
              ctx.fillText(`${gust[i]} mph`,365,y);

              ctx.fillText("ENE",500,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,620,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,740,y);

              ctx.fillStyle=hazardColor(wind[i],wave[i]);
              ctx.beginPath();ctx.arc(860,y-8,8,0,Math.PI*2);ctx.fill();

              y+=38;
            });

            // BUOY
            y+=30;
            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(100,y);ctx.lineTo(980,y);ctx.stroke();
            y+=35;

            ctx.font="bold 22px system-ui";
            ctx.fillText("ðŸ“¡ Latest Buoy Conditions",540,y);
            y+=30;

            ctx.font="20px system-ui";
            [["41043",b43],["41056",b56]].forEach(([id,b])=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(id,260,y);
              ctx.fillText(`${b.seas} ft`,420,y);
              ctx.fillText(`${b.period} s`,560,y);
              ctx.fillText(`${b.dir}Â°`,700,y);
              y+=34;
            });

            // FOOTER
            ctx.font="18px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit'})} AST â€¢ Rabirubia-Meteo â€¢ NOAA NDBC`,
              540,
              1030
            );
            ctx.textAlign="left";
          }

          run();
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Add color-coded wind cells, hazard dots, header/footer updates"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
