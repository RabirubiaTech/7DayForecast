name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind & Wave Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080,1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const ast = new Date(
            now.toLocaleString("en-US",{ timeZone:"America/Puerto_Rico" })
          );

          /* ================= BACKGROUND ================= */
          function drawOceanBackground(){
            const grad = ctx.createLinearGradient(0,0,0,1080);
            grad.addColorStop(0,"#fef3c7");
            grad.addColorStop(0.18,"#67e8f9");
            grad.addColorStop(0.45,"#22d3ee");
            grad.addColorStop(1,"#075985");
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,1080,1080);

            ctx.strokeStyle = "rgba(255,255,255,0.07)";
            ctx.lineWidth = 2;
            for(let y=220;y<1080;y+=85){
              ctx.beginPath();
              ctx.moveTo(0,y);
              ctx.bezierCurveTo(320,y-14,760,y+14,1080,y);
              ctx.stroke();
            }
          }

          /* ================= HELPERS ================= */
          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;

          const circularMean = d => {
            const r = d.map(v=>v*Math.PI/180);
            return (Math.atan2(
              r.reduce((a,v)=>a+Math.sin(v),0),
              r.reduce((a,v)=>a+Math.cos(v),0)
            )*180/Math.PI+360)%360;
          };

          function compass(d){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }

          function windColor(s){
            if(s<=10)return"#38bdf8";
            if(s<=15)return"#22c55e";
            if(s<=20)return"#eab308";
            if(s<=25)return"#f97316";
            return"#ef4444";
          }

          function hazardDot(w,h){
            if(w>25||h>6)return"#ef4444";
            if(w>=15||h>=4)return"#eab308";
            return"#22c55e";
          }

          /* ================= DRAW CARD ================= */
          function drawCard(days,wave,period,wind,gust,dir,buoys,logo){

            drawOceanBackground();

            ctx.fillStyle="rgba(248,250,252,0.93)";
            ctx.fillRect(40,40,1000,1000);

            ctx.drawImage(logo,460,70,160,160);

            ctx.font="bold 30px system-ui";
            ctx.fillStyle="#0f172a";
            ctx.textAlign="center";
            ctx.fillText(
              "7-Day Nearshore (East of PR) Wind & Wave Forecast",
              540,
              260
            );
            ctx.textAlign="left";

            ctx.font="bold 20px system-ui";
            ctx.fillStyle="#334155";
            const hy=320;
            ctx.fillText("Date",80,hy);
            ctx.fillText("Wind",220,hy);
            ctx.fillText("Gust",330,hy);
            ctx.fillText("Dir",440,hy);
            ctx.fillText("Seas",550,hy);
            ctx.fillText("Per",660,hy);

            ctx.strokeStyle="#cbd5e1";
            ctx.beginPath();
            ctx.moveTo(80,335);
            ctx.lineTo(960,335);
            ctx.stroke();

            let y=375;
            ctx.font="22px system-ui";

            days.forEach((d,i)=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(
                new Date(d).toLocaleDateString('en-US',{ weekday:'short' }),
                80,y
              );

              ctx.fillStyle=windColor(wind[i]);
              ctx.fillText(`${Math.round(wind[i])}`,220,y);
              ctx.fillText(`${Math.round(gust[i])}`,330,y);

              ctx.fillStyle="#0f172a";
              ctx.fillText(compass(dir[i]),440,y);
              ctx.fillText(`${wave[i].toFixed(1)}`,550,y);
              ctx.fillText(`${period[i].toFixed(1)}`,660,y);

              ctx.fillStyle=hazardDot(wind[i],wave[i]);
              ctx.beginPath();
              ctx.arc(760,y-6,7,0,Math.PI*2);
              ctx.fill();

              y+=56;
            });

            y+=18;
            ctx.font="bold 22px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.fillText("Latest Buoy Conditions",80,y);
            y+=30;

            ctx.font="20px system-ui";
            buoys.forEach(b=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(b.name,80,y);
              ctx.fillText(b.wave,360,y);
              ctx.fillText(b.period,480,y);
              ctx.fillText(b.dir,620,y);
              y+=36;
            });

            ctx.font="18px system-ui";
            ctx.fillStyle="#334155";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit',second:'2-digit'})} AST â€¢ Rabirubia-Meteo`,
              540,
              1020
            );
            ctx.textAlign="left";
          }

          /* ========= IMPORTANT FIX: START FORECAST FROM TODAY ========= */
          // daily{} is already built earlier in your script

          const todayAST = new Date(
            ast.getFullYear(),
            ast.getMonth(),
            ast.getDate()
          );

          const days = [];
          for (let i=0;i<7;i++){
            const d = new Date(todayAST);
            d.setDate(todayAST.getDate()+i);
            const key = d.toISOString().split("T")[0];
            if (daily[key]) days.push(key);
          }

          const wave   = days.map(d=>Math.max(...daily[d].wave));
          const period = days.map(d=>mean(daily[d].period));
          const wind   = days.map(d=>Math.max(...daily[d].wind));
          const gust   = days.map(d=>Math.max(...daily[d].gust));
          const dir    = days.map(d=>circularMean(daily[d].dir));

          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Fix forecast table to start on run date (AST)"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
