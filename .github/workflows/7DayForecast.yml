name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install canvas node-fetch@2

      - name: Generate Forecast Card
        run: |
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const W = 1080, H = 1080;
          const canvas = createCanvas(W, H);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const ast = new Date(now.toLocaleString("en-US", { timeZone: "America/Puerto_Rico" }));

          const GRID_POINTS = [
            [18.05,-65.45],[18.10,-65.35],[18.05,-65.25],
            [18.25,-65.25],[18.20,-65.15],[18.25,-65.05],
            [18.25,-64.95],[18.20,-64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
          const circularMean = d => {
            const r=d.map(v=>v*Math.PI/180);
            return (Math.atan2(
              r.reduce((a,v)=>a+Math.sin(v),0),
              r.reduce((a,v)=>a+Math.cos(v),0)
            )*180/Math.PI+360)%360;
          };

          function compass(d){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }
          function windColor(s){
            if(s<=10)return"#38bdf8";
            if(s<=15)return"#22c55e";
            if(s<=20)return"#eab308";
            if(s<=25)return"#f97316";
            return"#ef4444";
          }

          async function fetchPoint(lat, lon){
            const marine =
              "https://marine-api.open-meteo.com/v1/marine"+
              `?latitude=${lat}&longitude=${lon}`+
              "&hourly=wave_height,wave_period,wave_direction"+
              "&timezone=America/Puerto_Rico";

            const weather =
              "https://api.open-meteo.com/v1/forecast"+
              `?latitude=${lat}&longitude=${lon}`+
              "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m"+
              "&wind_speed_unit=mph"+
              "&timezone=America/Puerto_Rico";

            const [m,w] = await Promise.all([
              fetch(marine).then(r=>r.json()),
              fetch(weather).then(r=>r.json())
            ]);
            return {m,w};
          }

          async function run(){

            /* BACKGROUND */
            const bg = await loadImage(
              "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1600&q=80"
            );
            ctx.drawImage(bg,0,0,W,H);
            ctx.fillStyle="rgba(248,250,252,0.92)";
            ctx.fillRect(40,40,W-80,H-80);

            /* DATA */
            const responses = await Promise.all(GRID_POINTS.map(p=>fetchPoint(p[0],p[1])));
            const time = responses[0].m.hourly.time;
            const daily = {};

            time.forEach((t,i)=>{
              const d=t.split("T")[0];
              daily[d] ??= {wave:[],period:[],wind:[],gust:[],dir:[]};

              const waves = responses.map(r=>r.m.hourly.wave_height[i]).filter(v=>v!=null);
              const periods = responses.map(r=>r.m.hourly.wave_period[i]).filter(v=>v!=null);
              const winds = responses.map(r=>r.w.hourly.wind_speed_10m[i]).filter(v=>v!=null);
              const gusts = responses.map(r=>r.w.hourly.wind_gusts_10m[i]).filter(v=>v!=null);
              const dirs  = responses.map(r=>r.w.hourly.wind_direction_10m[i]).filter(v=>v!=null);

              if(!waves.length) return;

              daily[d].wave.push(mean(waves)*WAVE_DAMPING);
              daily[d].period.push(mean(periods));
              daily[d].wind.push(mean(winds)*WIND_DAMPING);
              daily[d].gust.push(mean(gusts)*WIND_DAMPING);
              daily[d].dir.push(circularMean(dirs));
            });

            const today = new Date(ast.getFullYear(),ast.getMonth(),ast.getDate());
            const days=[];
            for(let i=0;i<7;i++){
              const d=new Date(today);
              d.setDate(today.getDate()+i);
              const k=d.toISOString().split("T")[0];
              if(daily[k]) days.push(k);
            }

            const wave=days.map(d=>Math.max(...daily[d].wave));
            const period=days.map(d=>mean(daily[d].period));
            const wind=days.map(d=>Math.max(...daily[d].wind));
            const gust=days.map(d=>Math.max(...daily[d].gust));
            const dir=days.map(d=>circularMean(daily[d].dir));

            /* HEADER BLOCK (NO OVERLAP) */
            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            const headerY = 115;
            ctx.drawImage(logo, W/2 - 230, headerY - 40, 70, 70);

            ctx.font="bold 22px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.textAlign="left";
            ctx.fillText(
              "7-Day Nearshore (East of PR) Wind & Wave Forecast",
              W/2 - 140,
              headerY
            );

            /* COLUMN HEADERS */
            ctx.font="bold 18px system-ui";
            ctx.fillStyle="#334155";
            const xs=[140,300,420,540,660,780];
            ["ðŸ“… Date","ðŸ’¨ Wind","ðŸŒ¬ Gusts","ðŸ§­ Dir","ðŸŒŠ Seas","â± Period"]
              .forEach((h,i)=>ctx.fillText(h,xs[i],270));

            /* TABLE (LARGER DATA FONT) */
            let y=315;
            days.forEach((d,i)=>{
              ctx.font="18px system-ui";
              ctx.fillStyle="#0f172a";
              ctx.fillText(new Date(d).toLocaleDateString("en-US",{weekday:"short"}),xs[0],y);

              ctx.fillStyle=windColor(wind[i]);
              ctx.fillText(`${Math.round(wind[i])} mph`,xs[1],y);
              ctx.fillText(`${Math.round(gust[i])} mph`,xs[2],y);

              ctx.fillStyle="#0f172a";
              ctx.fillText(compass(dir[i]),xs[3],y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,xs[4],y);
              ctx.fillText(`${period[i].toFixed(1)} s`,xs[5],y);

              ctx.fillStyle=wind[i]>=20?"#ef4444":"#22c55e";
              ctx.beginPath();
              ctx.arc(xs[5]+90,y-6,6,0,Math.PI*2);
              ctx.fill();

              y+=44;
            });

            /* FOOTER */
            ctx.font="16px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString("en-US",{hour:"numeric",minute:"2-digit"})} AST â€¢ Rabirubia-Meteo`,
              W/2,
              1010
            );

            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          run().catch(e=>{console.error(e);process.exit(1)});
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Fix header/logo overlap, adjust font sizes"
          git push
