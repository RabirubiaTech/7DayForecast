name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind, Wave & Buoy Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const ast = new Date(now.toLocaleString("en-US", { timeZone: "America/Puerto_Rico" }));

          const mToFt = m => (m && !isNaN(m)) ? (m * 3.28084).toFixed(1) : "N/A";

          // --------------------------------------------------
          // Buoy fetch (translated from your Python logic)
          // --------------------------------------------------
          async function fetchBuoy(id) {
            try {
              const url = `https://www.ndbc.noaa.gov/data/realtime2/${id}.txt`;
              const txt = await fetch(url, { timeout: 15000 }).then(r => r.text());
              const lines = txt.split('\n');

              let headers;
              const rows = [];

              for (const ln of lines) {
                if (ln.startsWith('#YY')) {
                  headers = ln.replace('#','').trim().split(/\s+/);
                } else if (headers && !ln.startsWith('#') && ln.trim()) {
                  rows.push(ln.trim().split(/\s+/));
                }
              }

              const idx = k => headers.indexOf(k);

              const parsed = rows.map(p => {
                try {
                  const ts = new Date(
                    Number(p[idx('YY')]),
                    Number(p[idx('MM')]) - 1,
                    Number(p[idx('DD')]),
                    Number(p[idx('hh')]),
                    Number(p[idx('mm')])
                  );
                  return { ts, p };
                } catch { return null; }
              }).filter(Boolean).sort((a,b)=>b.ts-a.ts);

              for (const r of parsed) {
                const wvht = r.p[idx('WVHT')];
                if (wvht !== 'MM' && wvht !== '99.00') {
                  return {
                    id,
                    height: mToFt(parseFloat(wvht)),
                    period: r.p[idx('DPD')] !== 'MM' ? `${r.p[idx('DPD')]} s` : "N/A",
                    dir: r.p[idx('MWD')] !== '999' ? `${r.p[idx('MWD')]}°` : "N/A",
                    time: r.ts.toLocaleString('en-US',{hour:'2-digit',minute:'2-digit'})
                  };
                }
              }
            } catch {}
            return { id, height:"N/A", period:"N/A", dir:"N/A", time:"N/A" };
          }

          // --------------------------------------------------
          // Existing forecast logic (unchanged)
          // --------------------------------------------------
          const GRID_POINTS = [
            [18.05, -65.45],[18.10, -65.35],[18.05, -65.25],
            [18.25, -65.25],[18.20, -65.15],[18.25, -65.05],
            [18.25, -64.95],[18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          async function fetchPoint(lat, lon) {
            const marineURL =
              `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height,wave_period&timezone=America/Puerto_Rico`;
            const weatherURL =
              `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m&wind_speed_unit=mph&timezone=America/Puerto_Rico`;

            const [m,w] = await Promise.all([
              fetch(marineURL).then(r=>r.json()),
              fetch(weatherURL).then(r=>r.json())
            ]);
            return { m, w };
          }

          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;

          async function run() {
            const points = (await Promise.all(GRID_POINTS.map(p=>fetchPoint(p[0],p[1]))));
            const t = points[0].m.hourly.time;
            const daily = {};

            t.forEach((_,i)=>{
              const d = t[i].split('T')[0];
              daily[d] ??= { wave:[], period:[], wind:[], gust:[] };
              daily[d].wave.push(mean(points.map(p=>p.m.hourly.wave_height[i]))*WAVE_DAMPING);
              daily[d].period.push(mean(points.map(p=>p.m.hourly.wave_period[i])));
              daily[d].wind.push(mean(points.map(p=>p.w.hourly.wind_speed_10m[i]))*WIND_DAMPING);
              daily[d].gust.push(mean(points.map(p=>p.w.hourly.wind_gusts_10m[i]))*WIND_DAMPING);
            });

            const days = Object.keys(daily).slice(0,7);
            const wind = days.map(d=>Math.max(...daily[d].wind));
            const gust = days.map(d=>Math.max(...daily[d].gust));
            const wave = days.map(d=>Math.max(...daily[d].wave));
            const period = days.map(d=>mean(daily[d].period));

            const buoy43 = await fetchBuoy("41043");
            const buoy56 = await fetchBuoy("41056");

            draw(days,wind,gust,wave,period,buoy43,buoy56);
            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          function draw(days,wind,gust,wave,period,b43,b56){
            ctx.fillStyle="#f8fafc";ctx.fillRect(0,0,1080,1080);

            ctx.font="bold 26px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.fillText("7-Day Nearshore Wind & Wave Forecast",60,80);

            ctx.font="20px system-ui";
            let y=130;
            days.forEach((d,i)=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(new Date(d).toLocaleDateString('en-US',{weekday:'short'}),60,y);
              ctx.fillText(`${Math.round(wind[i])} mph`,200,y);
              ctx.fillText(`${Math.round(gust[i])} mph`,320,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,500,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,620,y);
              y+=42;
            });

            // ---- BUOY SECTION ----
            y+=30;
            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(60,y);ctx.lineTo(1020,y);ctx.stroke();
            y+=30;

            ctx.font="bold 22px system-ui";
            ctx.fillText("Latest Buoy Conditions",60,y);
            y+=30;

            ctx.font="18px system-ui";
            ctx.fillText("Buoy",60,y);
            ctx.fillText("Seas",200,y);
            ctx.fillText("Period",320,y);
            ctx.fillText("Dir",460,y);
            ctx.fillText("Time",580,y);

            y+=28;
            [[b43,"41043"],[b56,"41056"]].forEach(([b,id])=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(id,60,y);
              ctx.fillText(b.height+" ft",200,y);
              ctx.fillText(b.period,320,y);
              ctx.fillText(b.dir,460,y);
              ctx.fillText(b.time,580,y);
              y+=30;
            });

            ctx.font="18px system-ui";
            ctx.textAlign="center";
            ctx.fillStyle="#475569";
            ctx.fillText(`Updated ${ast.toLocaleString()} AST • Open-Meteo + NOAA NDBC`,540,1040);
            ctx.textAlign="left";
          }

          run();
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Add NOAA buoy 41043 & 41056 section"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
