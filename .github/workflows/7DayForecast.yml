name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind, Wave & Buoy Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080,1080);
          const ctx = canvas.getContext('2d');

          const ast = new Date(new Date().toLocaleString("en-US",{timeZone:"America/Puerto_Rico"}));

          const mToFt = m => (m && !isNaN(m)) ? (m*3.28084).toFixed(1) : "N/A";

          async function fetchBuoy(id){
            try{
              const txt = await fetch(`https://www.ndbc.noaa.gov/data/realtime2/${id}.txt`).then(r=>r.text());
              const lines = txt.split('\n');
              let headers; const rows=[];
              for(const l of lines){
                if(l.startsWith("#YY")) headers=l.replace("#","").trim().split(/\s+/);
                else if(headers && !l.startsWith("#") && l.trim()) rows.push(l.trim().split(/\s+/));
              }
              const i=k=>headers.indexOf(k);
              for(const r of rows){
                if(r[i("WVHT")]!=="MM" && r[i("WVHT")]!=="99.00"){
                  return{
                    id,
                    h:mToFt(parseFloat(r[i("WVHT")])),
                    p:r[i("DPD")]!=="MM"?`${r[i("DPD")]} s`:"N/A",
                    d:r[i("MWD")]!=="999"?`${r[i("MWD")]}Â°`:"N/A"
                  }
                }
              }
            }catch{}
            return{id,height:"N/A",period:"N/A",dir:"N/A"}
          }

          async function run(){
            const dummyDays=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
            const wind=[12,14,13,15,14,13,12];
            const gust=[17,18,17,19,18,17,16];
            const wave=[3.8,4.1,3.9,4.3,4.0,3.7,3.6];
            const period=[8.1,8.4,8.2,8.6,8.3,8.0,7.9];

            const buoy43=await fetchBuoy("41043");
            const buoy56=await fetchBuoy("41056");

            const logo=await loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png");

            draw(dummyDays,wind, gust, wave, period, buoy43, buoy56, logo);
            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          function draw(days,wind,gust,wave,period,b43,b56,logo){
            ctx.fillStyle="#f8fafc";
            ctx.fillRect(0,0,1080,1080);

            // LOGO
            ctx.drawImage(logo,60,40,100,100);

            // HEADER
            ctx.font="bold 30px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.textAlign="center";
            ctx.fillText("7-Day Nearshore Wind & Wave Forecast",540,95);

            // COLUMN HEADERS
            ctx.font="bold 20px system-ui";
            ctx.fillStyle="#334155";
            const hy=170;
            ctx.fillText("ðŸ“… Date",120,hy);
            ctx.fillText("ðŸŒ¬ Wind",260,hy);
            ctx.fillText("ðŸ’¨ Gusts",380,hy);
            ctx.fillText("ðŸ§­ Dir",500,hy);
            ctx.fillText("ðŸŒŠ Seas",620,hy);
            ctx.fillText("â± Period",760,hy);

            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(100,185);ctx.lineTo(980,185);ctx.stroke();

            // FORECAST ROWS
            ctx.font="20px system-ui";
            let y=225;
            days.forEach((d,i)=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(d,120,y);
              ctx.fillText(`${wind[i]} mph`,260,y);
              ctx.fillText(`${gust[i]} mph`,380,y);
              ctx.fillText("ENE",500,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,620,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,760,y);
              y+=38;
            });

            // BUOY SECTION
            y+=20;
            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(100,y);ctx.lineTo(980,y);ctx.stroke();
            y+=35;

            ctx.font="bold 22px system-ui";
            ctx.fillText("ðŸ“¡ Latest Buoy Conditions",540,y);
            y+=30;

            ctx.font="20px system-ui";
            ctx.fillText("Buoy",260,y);
            ctx.fillText("Seas",420,y);
            ctx.fillText("Period",560,y);
            ctx.fillText("Dir",700,y);

            y+=32;
            [[b43,"41043"],[b56,"41056"]].forEach(([b,id])=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(id,260,y);
              ctx.fillText(`${b.h} ft`,420,y);
              ctx.fillText(b.p,560,y);
              ctx.fillText(b.d,700,y);
              y+=34;
            });

            // FOOTER
            ctx.font="18px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit'})} AST â€¢ Open-Meteo + NOAA NDBC`,
              540,
              1030
            );
            ctx.textAlign="left";
          }

          run();
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Finalize layout: logo, headers, icons, buoy section"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
