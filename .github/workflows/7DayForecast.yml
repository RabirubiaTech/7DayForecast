name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate 7-Day Wind & Wave Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const astTime = new Date(now.getTime() - 4 * 60 * 60 * 1000);

          // -----------------------------
          // Near-shore tuned micro-grid
          // Vieques / Culebra / St. Thomas
          // -----------------------------
          const GRID_POINTS = [
            [18.05, -65.45],
            [18.10, -65.35],
            [18.05, -65.25],
            [18.25, -65.25],
            [18.20, -65.15],
            [18.25, -65.05],
            [18.25, -64.95],
            [18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          async function fetchPoint(lat, lon) {
            const marineURL =
              "https://marine-api.open-meteo.com/v1/marine" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wave_height,wave_period,wave_direction" +
              "&timezone=America/Puerto_Rico";

            const weatherURL =
              "https://api.open-meteo.com/v1/forecast" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m" +
              "&timezone=America/Puerto_Rico";

            const [marine, weather] = await Promise.all([
              fetch(marineURL).then(r => r.json()),
              fetch(weatherURL).then(r => r.json())
            ]);

            return { marine, weather };
          }

          function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
          }

          function circularMean(degArray) {
            const rad = degArray.map(d => d * Math.PI / 180);
            const sin = rad.reduce((a, v) => a + Math.sin(v), 0);
            const cos = rad.reduce((a, v) => a + Math.cos(v), 0);
            return (Math.atan2(sin, cos) * 180 / Math.PI + 360) % 360;
          }

          function groupByDay(times, values) {
            const map = {};
            times.forEach((t, i) => {
              const day = t.split('T')[0];
              map[day] ??= [];
              map[day].push(values[i]);
            });
            return map;
          }

          async function run() {
            const responses = await Promise.all(
              GRID_POINTS.map(p => fetchPoint(p[0], p[1]))
            );

            const days = [];
            const wave = [];
            const period = [];
            const wind = [];
            const gust = [];
            const dir = [];

            const ref = responses[0];
            const time = ref.marine.hourly.time;

            const waveDaily = [];
            const periodDaily = [];
            const windDaily = [];
            const gustDaily = [];
            const dirDaily = [];

            const byDay = {};

            time.forEach((t, i) => {
              const day = t.split('T')[0];
              byDay[day] ??= { wave: [], period: [], wind: [], gust: [], dir: [] };

              const waves = responses.map(r => r.marine.hourly.wave_height[i]);
              const periods = responses.map(r => r.marine.hourly.wave_period[i]);
              const winds = responses.map(r => r.weather.hourly.wind_speed_10m[i]);
              const gusts = responses.map(r => r.weather.hourly.wind_gusts_10m[i]);
              const dirs = responses.map(r => r.weather.hourly.wind_direction_10m[i]);

              byDay[day].wave.push(mean(waves) * WAVE_DAMPING);
              byDay[day].period.push(mean(periods));
              byDay[day].wind.push(mean(winds) * WIND_DAMPING);
              byDay[day].gust.push(mean(gusts) * WIND_DAMPING);
              byDay[day].dir.push(circularMean(dirs));
            });

            Object.keys(byDay).slice(0, 7).forEach(day => {
              days.push(day);
              wave.push(Math.max(...byDay[day].wave));
              period.push(mean(byDay[day].period));
              wind.push(Math.max(...byDay[day].wind));
              gust.push(Math.max(...byDay[day].gust));
              dir.push(circularMean(byDay[day].dir));
            });

            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,enc_avif,quality_auto/RWRoundLogoTransp.png"
            );

            drawCard(days, wave, period, wind, gust, dir, logo, astTime);
            fs.writeFileSync('rabirubia_7day_windwave.png', canvas.toBuffer());
          }

          // ---- existing draw helpers unchanged ----
          // (compass, arrowForDir, windColor, dangerFlag, icons, drawCard)
          // KEEP YOUR ORIGINAL IMPLEMENTATION BELOW THIS LINE

          // ⬇️ PASTE YOUR EXISTING draw helpers + drawCard HERE ⬇️

          run().catch(e => {
            console.error(e);
            process.exit(1);
          });
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Nearshore-tuned marine forecast (PR/USVI)" && git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
