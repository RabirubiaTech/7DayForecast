name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          set -e
          npm install canvas node-fetch@2

      - name: Generate Forecast Card
        run: |
          set -e
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const canvas = createCanvas(1080,1080);
          const ctx = canvas.getContext('2d');

          const ast = new Date(new Date().toLocaleString("en-US",{timeZone:"America/Puerto_Rico"}));

          const windColor = v => v<=10?"#38bdf8":v<=15?"#22c55e":v<=20?"#eab308":v<=25?"#f97316":"#ef4444";
          const hazardColor = (w,h)=> (w>=25||h>=6)?"#ef4444":(w>=15||h>=4)?"#eab308":"#22c55e";

          const cell = (x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};

          async function fetchBuoy(id){
            try{
              const t = await fetch(`https://www.ndbc.noaa.gov/data/realtime2/${id}.txt`).then(r=>r.text());
              const l=t.split('\n'); let h; const r=[];
              for(const ln of l){
                if(ln.startsWith("#YY"))h=ln.replace("#","").trim().split(/\s+/);
                else if(h&&!ln.startsWith("#")&&ln.trim())r.push(ln.trim().split(/\s+/));
              }
              const i=k=>h.indexOf(k);
              for(const p of r){
                if(p[i("WVHT")]!=="MM"&&p[i("WVHT")]!=="99.00"){
                  return{
                    seas:(p[i("WVHT")]*3.28084).toFixed(1),
                    period:p[i("DPD")]!=="MM"?p[i("DPD")]:"N/A",
                    dir:p[i("MWD")]!=="999"?p[i("MWD")]:"N/A"
                  }
                }
              }
            }catch{}
            return{seas:"N/A",period:"N/A",dir:"N/A"}
          }

          async function run(){
            const days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
            const wind=[12,14,13,15,14,13,12];
            const gust=[17,18,17,19,18,17,16];
            const wave=[3.8,4.1,3.9,4.3,4.0,3.7,3.6];
            const period=[8.1,8.4,8.2,8.6,8.3,8.0,7.9];

            const b43=await fetchBuoy("41043");
            const b56=await fetchBuoy("41056");
            const logo=await loadImage("https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png");

            draw(days,wind,gust,wave,period,b43,b56,logo);
            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          function draw(days,wind,gust,wave,period,b43,b56,logo){
            ctx.fillStyle="#f8fafc";
            ctx.fillRect(0,0,1080,1080);

            // LOGO (centered)
            ctx.drawImage(logo,490,30,100,100);

            // HEADER (below logo)
            ctx.font="bold 28px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.textAlign="center";
            ctx.fillText(
              "7-Day Nearshore (East of PR) Wind & Wave Forecast",
              540,
              160
            );

            // TABLE HEADERS
            ctx.font="bold 20px system-ui";
            ctx.fillStyle="#334155";
            const hy=210;
            ["ðŸ“… Date","ðŸŒ¬ Wind","ðŸ’¨ Gusts","ðŸ§­ Dir","ðŸŒŠ Seas","â± Period",""].forEach((t,i)=>{
              ctx.fillText(t,140+i*120,hy);
            });

            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(120,225);ctx.lineTo(960,225);ctx.stroke();

            // ROWS
            let y=265;
            ctx.font="20px system-ui";
            days.forEach((d,i)=>{
              ctx.fillStyle="#0f172a";
              ctx.fillText(d,140,y);

              cell(260,y-18,90,28,windColor(wind[i]));
              ctx.fillStyle="#0f172a";
              ctx.fillText(`${wind[i]} mph`,265,y);

              cell(380,y-18,90,28,windColor(gust[i]));
              ctx.fillText(`${gust[i]} mph`,385,y);

              ctx.fillText("ENE",520,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,640,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,760,y);

              ctx.fillStyle=hazardColor(wind[i],wave[i]);
              ctx.beginPath();ctx.arc(880,y-8,8,0,Math.PI*2);ctx.fill();

              y+=38;
            });

            // BUOY SECTION
            y+=30;
            ctx.strokeStyle="#cbd5f5";
            ctx.beginPath();ctx.moveTo(120,y);ctx.lineTo(960,y);ctx.stroke();
            y+=40;

            ctx.font="bold 22px system-ui";
            ctx.fillText("ðŸ“¡ Latest Buoy Conditions",540,y);
            y+=36;

            ctx.font="20px system-ui";
            ctx.fillStyle="#0f172a";

            ctx.fillText("41043-North of PR",320,y);
            ctx.fillText(`${b43.seas} ft`,560,y);
            ctx.fillText(`${b43.period} s`,700,y);
            ctx.fillText(`${b43.dir}Â°`,820,y);

            y+=34;

            ctx.fillText("41056-Near Vieques",320,y);
            ctx.fillText(`${b56.seas} ft`,560,y);
            ctx.fillText(`${b56.period} s`,700,y);
            ctx.fillText(`${b56.dir}Â°`,820,y);

            // FOOTER
            ctx.font="18px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit'})} AST â€¢ Rabirubia-Meteo â€¢ NOAA NDBC`,
              540,
              1030
            );
          }

          run();
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Fix header/logo spacing and buoy labels"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
