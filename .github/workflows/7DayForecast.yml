name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install canvas node-fetch@2

      - name: Generate Forecast Card
        run: |
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require('canvas');
          const fetch = require('node-fetch');
          const fs = require('fs');

          const WIDTH = 1080;
          const HEIGHT = 1080;
          const canvas = createCanvas(WIDTH, HEIGHT);
          const ctx = canvas.getContext('2d');

          const now = new Date();
          const ast = new Date(now.toLocaleString("en-US", { timeZone: "America/Puerto_Rico" }));

          const GRID_POINTS = [
            [18.05, -65.45], [18.10, -65.35], [18.05, -65.25],
            [18.25, -65.25], [18.20, -65.15], [18.25, -65.05],
            [18.25, -64.95], [18.20, -64.95]
          ];

          const WAVE_DAMPING = 0.75;
          const WIND_DAMPING = 0.85;

          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
          const circularMean = d => {
            const r=d.map(v=>v*Math.PI/180);
            return (Math.atan2(
              r.reduce((a,v)=>a+Math.sin(v),0),
              r.reduce((a,v)=>a+Math.cos(v),0)
            )*180/Math.PI+360)%360;
          };

          async function fetchPoint(lat, lon) {
            const marineURL =
              "https://marine-api.open-meteo.com/v1/marine" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wave_height,wave_period,wave_direction" +
              "&timezone=America/Puerto_Rico";

            const weatherURL =
              "https://api.open-meteo.com/v1/forecast" +
              `?latitude=${lat}&longitude=${lon}` +
              "&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m" +
              "&wind_speed_unit=mph" +
              "&timezone=America/Puerto_Rico";

            const [marine, weather] = await Promise.all([
              fetch(marineURL).then(r => r.json()),
              fetch(weatherURL).then(r => r.json())
            ]);

            return { marine, weather };
          }

          function compass(d){
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          }

          function windColor(s){
            if(s<=10)return"#38bdf8";
            if(s<=15)return"#22c55e";
            if(s<=20)return"#eab308";
            if(s<=25)return"#f97316";
            return"#ef4444";
          }

          async function run() {

            /* ---------- BACKGROUND ---------- */
            const bg = await loadImage(
              "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1600&q=80"
            );
            ctx.drawImage(bg, 0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = "rgba(248,250,252,0.88)";
            ctx.fillRect(40, 40, WIDTH-80, HEIGHT-80);

            /* ---------- DATA FETCH ---------- */
            const responses = (await Promise.all(
              GRID_POINTS.map(p => fetchPoint(p[0], p[1]))
            )).filter(Boolean);

            const time = responses[0].marine.hourly.time;
            const daily = {};

            time.forEach((t,i)=>{
              const day=t.split('T')[0];
              daily[day] ??= { wave:[], period:[], wind:[], gust:[], dir:[] };

              const waves = responses.map(r=>r.marine.hourly.wave_height[i]).filter(v=>v!=null);
              const periods = responses.map(r=>r.marine.hourly.wave_period[i]).filter(v=>v!=null);
              const winds = responses.map(r=>r.weather.hourly.wind_speed_10m[i]).filter(v=>v!=null);
              const gusts = responses.map(r=>r.weather.hourly.wind_gusts_10m[i]).filter(v=>v!=null);
              const dirs = responses.map(r=>r.weather.hourly.wind_direction_10m[i]).filter(v=>v!=null);

              if(!waves.length || !winds.length) return;

              daily[day].wave.push(mean(waves)*WAVE_DAMPING);
              daily[day].period.push(mean(periods));
              daily[day].wind.push(mean(winds)*WIND_DAMPING);
              daily[day].gust.push(mean(gusts)*WIND_DAMPING);
              daily[day].dir.push(circularMean(dirs));
            });

            /* ---------- TODAY + 6 DAYS ---------- */
            const today = new Date(ast.getFullYear(), ast.getMonth(), ast.getDate());
            const days = [];

            for(let i=0;i<7;i++){
              const d=new Date(today);
              d.setDate(today.getDate()+i);
              const key=d.toISOString().split('T')[0];
              if(daily[key]) days.push(key);
            }

            const wave = days.map(d=>Math.max(...daily[d].wave));
            const period = days.map(d=>mean(daily[d].period));
            const wind = days.map(d=>Math.max(...daily[d].wind));
            const gust = days.map(d=>Math.max(...daily[d].gust));
            const dir = days.map(d=>circularMean(daily[d].dir));

            /* ---------- HEADER ---------- */
            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );
            ctx.drawImage(logo, 120, 90, 90, 90);

            ctx.font="bold 28px system-ui";
            ctx.fillStyle="#1e40af";
            ctx.textAlign="center";
            ctx.fillText(
              "7-Day Nearshore (East of PR) Wind & Wave Forecast",
              WIDTH/2 + 40,
              135
            );
            ctx.textAlign="left";

            /* ---------- TABLE ---------- */
            let y=310;
            ctx.font="bold 18px system-ui";
            ctx.fillStyle="#334155";
            ["Date","Wind","Gusts","Dir","Seas","Period"].forEach((h,i)=>{
              ctx.fillText(h, [120,260,360,460,560,660][i], y);
            });

            y+=30;
            days.forEach((d,i)=>{
              ctx.font="16px system-ui";
              ctx.fillStyle="#0f172a";
              ctx.fillText(new Date(d).toLocaleDateString('en-US',{weekday:'short'}),120,y);

              ctx.fillStyle=windColor(wind[i]);
              ctx.fillText(`${Math.round(wind[i])} mph`,260,y);
              ctx.fillText(`${Math.round(gust[i])} mph`,360,y);

              ctx.fillStyle="#0f172a";
              ctx.fillText(compass(dir[i]),460,y);
              ctx.fillText(`${wave[i].toFixed(1)} ft`,560,y);
              ctx.fillText(`${period[i].toFixed(1)} s`,660,y);

              ctx.fillStyle=wind[i]>=20?"#ef4444":"#22c55e";
              ctx.beginPath();
              ctx.arc(740,y-5,6,0,Math.PI*2);
              ctx.fill();

              y+=42;
            });

            /* ---------- FOOTER ---------- */
            ctx.font="16px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleString('en-US',{hour:'numeric',minute:'2-digit'})} AST â€¢ Rabirubia-Meteo`,
              WIDTH/2,
              1010
            );

            fs.writeFileSync("rabirubia_7day_windwave.png", canvas.toBuffer());
          }

          run().catch(e=>{console.error(e);process.exit(1)});
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Fix forecast start date and daily scope"
          git push
