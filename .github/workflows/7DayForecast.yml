name: Update Rabirubia 7-Day Wind & Wave Card

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: rabirubia-forecast
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install canvas node-fetch@2

      - name: Generate Forecast Card
        run: |
          cat > generate.cjs << 'EOF'
          const { createCanvas, loadImage } = require("canvas");
          const fetch = require("node-fetch");
          const fs = require("fs");

          const W = 1080, H = 1080;
          const canvas = createCanvas(W, H);
          const ctx = canvas.getContext("2d");

          const ast = new Date(
            new Date().toLocaleString("en-US", { timeZone: "America/Puerto_Rico" })
          );

          /* ------------------ HELPERS ------------------ */
          const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
          const circularMean = d => {
            const r=d.map(v=>v*Math.PI/180);
            return (Math.atan2(
              r.reduce((a,v)=>a+Math.sin(v),0),
              r.reduce((a,v)=>a+Math.cos(v),0)
            )*180/Math.PI+360)%360;
          };
          const compass = d => {
            const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
            return dirs[Math.round(d/22.5)%16];
          };
          const windColor = s =>
            s<=10?"#38bdf8":s<=15?"#22c55e":s<=20?"#eab308":s<=25?"#f97316":"#ef4444";

          /* ------------------ BACKGROUND ------------------ */
          async function drawBackground() {
            const bg = await loadImage(
              "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1600&q=80"
            );
            ctx.drawImage(bg,0,0,W,H);
            ctx.fillStyle="rgba(248,250,252,0.92)";
            ctx.fillRect(40,40,W-80,H-80);
          }

          /* ------------------ BUOY FETCH ------------------ */
          async function fetchBuoy(id) {
            const txt = await fetch(`https://www.ndbc.noaa.gov/data/realtime2/${id}.txt`).then(r=>r.text());
            const lines = txt.split("\n");
            const header = lines.find(l=>l.startsWith("#YY")).replace("#","").split(/\s+/);
            const rows = lines.filter(l=>!l.startsWith("#") && l.trim());

            const idx = n => header.indexOf(n);
            for (const r of rows) {
              const p = r.split(/\s+/);
              if (p[idx("WVHT")] !== "MM") {
                return {
                  height: (p[idx("WVHT")]*3.281).toFixed(1)+" ft",
                  period: p[idx("DPD")]+" s",
                  dir: p[idx("MWD")]+"Â°"
                };
              }
            }
            return null;
          }

          /* ------------------ RUN ------------------ */
          async function run() {
            await drawBackground();

            /* ---------- HEADER (TRUE CENTERED) ---------- */
            const logo = await loadImage(
              "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png"
            );

            const title = "7-Day Nearshore (East of PR) Wind & Wave Forecast";
            ctx.font = "bold 22px system-ui";
            const textWidth = ctx.measureText(title).width;
            const gap = 16;
            const totalWidth = 60 + gap + textWidth;
            const startX = (W - totalWidth) / 2;

            ctx.drawImage(logo, startX, 90, 60, 60);
            ctx.fillStyle="#1e40af";
            ctx.fillText(title, startX + 60 + gap, 130);

            /* ---------- MOCK FORECAST DATA (UNCHANGED LOGIC) ---------- */
            const days=[0,1,2,3,4,5,6].map(i=>{
              const d=new Date(ast); d.setDate(ast.getDate()+i); return d;
            });

            const wind=[12,14,15,16,14,13,12];
            const gust=[18,20,21,22,20,18,17];
            const wave=[3.2,3.5,3.8,4.1,3.6,3.4,3.1];
            const period=[8,8.5,9,9.2,8.8,8.3,8];
            const dir=[80,85,90,95,100,90,85];

            /* ---------- TABLE HEADERS ---------- */
            const xs=[140,300,420,540,660,780];
            ctx.font="bold 18px system-ui";
            ctx.fillStyle="#334155";
            ["ðŸ“… Date","ðŸ’¨ Wind","ðŸŒ¬ Gusts","ðŸ§­ Dir","ðŸŒŠ Seas","â± Period"]
              .forEach((h,i)=>ctx.fillText(h,xs[i],260));

            /* ---------- TABLE ROWS ---------- */
            let y=305;
            days.forEach((d,i)=>{
              ctx.font="18px system-ui";
              ctx.fillStyle="#0f172a";
              ctx.fillText(d.toLocaleDateString("en-US",{weekday:"short"}),xs[0],y);

              ctx.fillStyle=windColor(wind[i]);
              ctx.fillText(`${wind[i]} mph`,xs[1],y);
              ctx.fillText(`${gust[i]} mph`,xs[2],y);

              ctx.fillStyle="#0f172a";
              ctx.fillText(compass(dir[i]),xs[3],y);
              ctx.fillText(`${wave[i]} ft`,xs[4],y);
              ctx.fillText(`${period[i]} s`,xs[5],y);

              ctx.fillStyle=wind[i]>=20?"#ef4444":"#22c55e";
              ctx.beginPath();ctx.arc(xs[5]+90,y-6,6,0,Math.PI*2);ctx.fill();
              y+=42;
            });

            /* ---------- BUOY SECTION ---------- */
            const buoy43 = await fetchBuoy("41043");
            const buoy56 = await fetchBuoy("41056");
            
            const buoyY = 640;
            const buoyW = 720;
            const buoyH = 130;
            const buoyX = (W - buoyW) / 2;
            const colW = buoyW / 2;
            
            /* Header */
            ctx.textAlign = "center";
            ctx.font = "bold 18px system-ui";
            ctx.fillStyle = "#1e293b";
            ctx.fillText("ðŸ“ NOAA Buoy Observations", W / 2, buoyY - 15);
            
            /* Container */
            ctx.fillStyle = "#f8fafc";
            ctx.strokeStyle = "#cbd5e1";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(buoyX, buoyY, buoyW, buoyH, 14);
            ctx.fill();
            ctx.stroke();
            
            /* Divider */
            ctx.beginPath();
            ctx.moveTo(buoyX + colW, buoyY);
            ctx.lineTo(buoyX + colW, buoyY + buoyH);
            ctx.stroke();
            
            /* Helper for color */
            const buoyColor = h => {
              if (!h) return "#e5e7eb";
              const v = parseFloat(h);
              return v <= 3 ? "#22c55e" : v <= 5 ? "#eab308" : "#ef4444";
            };
            
            ctx.font = "bold 16px system-ui";
            
            /* LEFT BUOY */
            ctx.fillStyle = buoyColor(buoy43?.height);
            ctx.fillText("41043 â€“ North of PR", buoyX + colW / 2, buoyY + 30);
            
            ctx.font = "15px system-ui";
            ctx.fillStyle = "#0f172a";
            ctx.fillText(`Seas: ${buoy43?.height}`, buoyX + colW / 2, buoyY + 58);
            ctx.fillText(`Period: ${buoy43?.period}`, buoyX + colW / 2, buoyY + 80);
            ctx.fillText(`Dir: ${buoy43?.dir}`, buoyX + colW / 2, buoyY + 102);
            
            /* RIGHT BUOY */
            ctx.font = "bold 16px system-ui";
            ctx.fillStyle = buoyColor(buoy56?.height);
            ctx.fillText("41056 â€“ Near Vieques", buoyX + colW + colW / 2, buoyY + 30);
            
            ctx.font = "15px system-ui";
            ctx.fillStyle = "#0f172a";
            ctx.fillText(`Seas: ${buoy56?.height}`, buoyX + colW + colW / 2, buoyY + 58);
            ctx.fillText(`Period: ${buoy56?.period}`, buoyX + colW + colW / 2, buoyY + 80);
            ctx.fillText(`Dir: ${buoy56?.dir}`, buoyX + colW + colW / 2, buoyY + 102);
            
            /* Restore alignment */
            ctx.textAlign = "left";

            /* ---------- FOOTER ---------- */
            ctx.font="16px system-ui";
            ctx.fillStyle="#475569";
            ctx.textAlign="center";
            ctx.fillText(
              `Updated ${ast.toLocaleTimeString("en-US")} AST â€¢ Rabirubia-Meteo`,
              W/2,
              1010
            );

            fs.writeFileSync("rabirubia_7day_windwave.png",canvas.toBuffer());
          }

          run().catch(e=>{console.error(e);process.exit(1)});
          EOF

          node generate.cjs

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add rabirubia_7day_windwave.png
          git diff --staged --quiet || git commit -m "Restore buoy data and true centered header"
          git push
